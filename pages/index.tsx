import { NextPage } from 'next';
import Head from 'next/head';
import Form from '@/components/ui/Forms/Form';
import ContentCard from '@/components/ui/ContentCard/ContentCard';
import { useEffect, useState } from 'react';
import { FormValues, Salary } from '@/interfaces/form';
import { formatAmount } from '@/utils/format';
import {
  computeSss,
  computePhilhealth,
  computePagIbig,
  computeTaxableIncome,
  computeTotalDeductions,
  computeWithholdingTax,
  isValidSalary,
} from '@/utils/formulas';
import styles from '../styles/Home.module.scss';
import { localize } from './locale';

const DEFAULT_SALARY = {
  taxDue: 0,
  sss: 0,
  philhealth: 0,
  pagibig: 0,
  overallDeductions: 0,
};

const DEFAULT_MONTHLY = {
  grossMonthly: 0,
  ...DEFAULT_SALARY,
  netMonthly: 0,
};

const DEFAULT_ANNUALY = {
  grossAnnual: 0,
  ...DEFAULT_SALARY,
  netAnnual: 0,
};

interface NetIncome {
  salary: number,
  deductions: number,
  taxDue: number
};

interface NetDifference {
  value: number|undefined,
  percentage: number|undefined,
};

const Home: NextPage = () => {
  const [currentSalary, setCurrentSalary] = useState<Salary>(DEFAULT_MONTHLY);
  const [increase, setIncrease] = useState<Salary>(DEFAULT_MONTHLY);
  const [salary, setSalary] = useState<number>(0);
  const [formType, setFormType] = useState<'raise' | 'annualIncome'>('raise');
  const [percentage, setPercentage] = useState<number>(0);
  const [netDifference, setNetDifference] = useState<NetDifference>({
    value: 0,
    percentage: 0,
  });

  const handleFormTypeChange = (formType:'raise' | 'annualIncome') => {
    setFormType(formType);
    setCurrentSalary(formType === 'raise' ? DEFAULT_MONTHLY : DEFAULT_ANNUALY);
  };

  const handleFormUpdate = ({ salary, percentage }: FormValues) => {
    setSalary(salary);
    setPercentage(percentage || 0);
  };

  const computeNetIncome = ({ salary, deductions, taxDue }: NetIncome) => {
    return salary - (deductions + taxDue);
  };

  const computeSalary = (type?: string) => {
    const salaryToCompute = type === 'increase'
      ? (salary + (percentage ? (salary * (percentage * 0.01)) : 0))
      : salary;
    const pagibig = computeSss(salaryToCompute);
    const philhealth = computePhilhealth(salaryToCompute);
    const sss = computePagIbig(salaryToCompute);
    const deductions: number = computeTotalDeductions({
      pagibig,
      philhealth,
      sss,
    });
    const taxableIncome: number = computeTaxableIncome({
      salary: salaryToCompute,
      deductions,
    });
    const taxDue: number = computeWithholdingTax(taxableIncome);
    const netMonthly = computeNetIncome({
      salary: salaryToCompute,
      deductions,
      taxDue,
    });
    const overallDeductions = taxDue + deductions;
    const isValid = (() => isValidSalary(salaryToCompute))();

    if (formType === 'raise') {
      return {
        grossMonthly: salaryToCompute,
        taxDue: taxDue,
        sss: sss,
        philhealth: isValid ? philhealth: 0,
        pagibig: isValid ? pagibig : 0,
        overallDeductions: isValid ? overallDeductions : 0,
        netMonthly: isValid ? netMonthly : 0,
      };
    } else {
      return {
        grossAnnual: salaryToCompute * 12,
        taxDue: taxDue * 12,
        sss: sss * 12,
        philhealth: isValid ? philhealth * 12: 0,
        pagibig: isValid ? pagibig * 12 : 0,
        overallDeductions: isValid ? overallDeductions * 12 : 0,
        netAnnual: isValid ? netMonthly * 12 : 0,
      };
    }
  };

  const getNetDifference = (
    current:number|undefined,
    increase:number|undefined,
  ):NetDifference => {
    return {
      value: (increase && current) && increase - current,
      percentage: current || increase
        ? (increase && current) && ((increase - current)/current)*100
        : 0,
    };
  };

  useEffect(() => {
    setCurrentSalary(computeSalary());
    setIncrease(percentage
      ? computeSalary('increase')
      : DEFAULT_MONTHLY
    );
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [salary, percentage]);

  useEffect(() => {
    const { netMonthly: current } = currentSalary;
    const { netMonthly: withIncrease } = increase;

    setNetDifference(getNetDifference(current, withIncrease));
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [currentSalary, increase]);

  return (
    <div>
      <Head>
        <title>salaraiseph</title>
        <meta name="description" content="Generated by create next app" />
      </Head>
      <main>
        <div className={styles['container']}>
          <div>
            <Form
              onFormUpdate={handleFormUpdate}
              onItemSelect={handleFormTypeChange}
            />
          </div>
          <div className={styles['content']}>
            <ContentCard
              currentSalaryData={currentSalary}
              increasedSalaryData={increase}
              contentType={formType}
            />
            {
              !!(percentage && isValidSalary(salary)) &&
              <p>
                {localize('raiseSummary', {
                  percentage: 
                    <strong className={styles['strong']}>
                      {percentage}%
                    </strong>,
                  netDifferenceValue:
                    <strong className={styles['strong']}>
                      â‚±{formatAmount(netDifference.value)}
                    </strong>,
                  netDifferencePercentage:
                    <strong className={styles['strong']}>
                      {formatAmount(netDifference.percentage)}%
                    </strong>,
                })}
              </p>
            }
          </div>
        </div>
      </main>
    </div>
  );
};

export default Home;